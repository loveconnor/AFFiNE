name: 'Prepare Server Test Environment'
description: 'Prepare Server Test Environment'

runs:
  using: 'composite'
  steps:
    - name: Initialize database
      shell: bash
      run: |
        psql -h localhost -U postgres -c "CREATE DATABASE lovenotes;"
        psql -h localhost -U postgres -c "CREATE USER lovenotes WITH PASSWORD 'lovenotes';"
        psql -h localhost -U postgres -c "ALTER USER lovenotes WITH SUPERUSER;"
      env:
        PGPASSWORD: lovenotes

    - name: Run init-db script
      shell: bash
      env:
        NODE_ENV: test
      run: |
        yarn lovenotes @lovenotes/server prisma generate
        yarn lovenotes @lovenotes/server prisma migrate deploy
        yarn lovenotes @lovenotes/server data-migration run

    - name: Import config
      shell: bash
      env:
        DEFAULT_CONFIG: '{}'
      run: |
        printf '%s\n' "${SERVER_CONFIG:-$DEFAULT_CONFIG}" > ./packages/backend/server/config.json
